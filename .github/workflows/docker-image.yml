name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  get-package-version-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: get-npm-version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@v1.3.1
        with:
          path: ./mozi-backend
      - run: echo ${{steps.package-version.outputs.current-version}}

  get-package-version-frontend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: get-npm-version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@v1.3.1
        with:
          path: ./mozi-frontend
      - run: echo ${{steps.package-version.outputs.current-version}}

  check-for-existing-docker-image-frontend:
    runs-on: ubuntu-latest
    needs: get-package-version-frontend
    continue-on-error: true
    steps:  
      - run: echo ${{needs.get-package-version-backend.outputs.current-version}}
      - uses: actions/checkout@v3
      - name: Check image
        id: image_exists
        uses: cloudposse/github-action-docker-image-exists@main
        with:
          registry: registry.hub.docker.com
          organization: "${{ github.event.repository.owner.login }}"
          repository: "${{ github.event.repository.name }}"
          login: "${{ secrets.DOCKERHUB_USERNAME }}"
          password: "${{ secrets.DOCKERHUB_PASSWORD }}"
          tag: frontend-v${{needs.get-package-version-frontend.outputs.current-version}}

    outputs:
      result: ${{ steps.image_exists.conclusion }}  
      image: ${{ steps.image_exists.outputs.image }}
      tag: ${{ steps.image_exists.outputs.tag }}

  check-for-existing-docker-image-backend:
    runs-on: ubuntu-latest
    needs: get-package-version-backend
    continue-on-error: true  
    steps:  
      - run: echo ${{needs.get-package-version-backend.outputs.current-version}}
      - uses: actions/checkout@v3
      - name: Check image
        id: image_exists
        uses: cloudposse/github-action-docker-image-exists@main
        with:
          registry: registry.hub.docker.com
          organization: "${{ github.event.repository.owner.login }}"
          repository: "${{ github.event.repository.name }}"
          login: "${{ secrets.DOCKERHUB_USERNAME }}"
          password: "${{ secrets.DOCKERHUB_PASSWORD }}"
          tag: backend-v${{needs.get-package-version-backend.outputs.current-version}}

    outputs:
      result: ${{ steps.image_exists.conclusion }}  
      image: ${{ steps.image_exists.outputs.image }}
      tag: ${{ steps.image_exists.outputs.tag }}
      

  build-frontend:

    runs-on: ubuntu-latest
    needs: [check-for-existing-docker-image-frontend, get-package-version-frontend]
    if: needs.check-for-existing-docker-image-frontend.outputs.result != 'true'
    steps:
    - uses: actions/checkout@v3
    - uses: mr-smithers-excellent/docker-build-push@v5
      name: Build & push frontend Docker image
      with:
        image: hamzabalazs/moviezone
        tags: frontend-v${{ needs.get-package-version-frontend.outputs.current-version }}
        registry: docker.io
        directory: ./mozi-frontend
        dockerfile: mozi-frontend/Dockerfile
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    
  
  build-backend:

    runs-on: ubuntu-latest
    needs: [check-for-existing-docker-image-backend, get-package-version-backend]
    if: needs.check-for-existing-docker-image-backend.outputs.result != 'true'
    steps:
    - uses: actions/checkout@v3
    - uses: mr-smithers-excellent/docker-build-push@v5
      name: Build & push backend Docker image
      with:
        image: hamzabalazs/moviezone
        tags: backend-v${{ needs.get-package-version-backend.outputs.current-version }}
        registry: docker.io
        directory: ./mozi-backend
        dockerfile: mozi-backend/Dockerfile
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
